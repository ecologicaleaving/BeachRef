# Story 1.2: VIS API Connection & Health Check

## Status
Draft

## Story
**As a** system administrator,
**I want** the application to establish and monitor connectivity to FIVB's VIS database,
**so that** I can ensure reliable access to tournament data.

## Acceptance Criteria
1. VIS API client library configured with proper authentication credentials
2. Health check endpoint that verifies VIS connectivity status
3. Error handling for VIS API connection failures with appropriate logging
4. API rate limiting and retry logic implemented
5. Basic VIS data retrieval test (e.g., tournament count) working successfully
6. Monitoring dashboard showing VIS connection status and response times

## Tasks / Subtasks
- [ ] Task 1: Create VIS API integration service (AC: 1, 5)
  - [ ] Create `vis_integration_service.dart` in `lib/services/` directory
  - [ ] Implement VIS API client using HTTP client with proper authentication
  - [ ] Configure API endpoints and base URL from environment variables
  - [ ] Implement basic tournament data retrieval method
  - [ ] Add Result<T, Error> pattern for consistent error handling
- [ ] Task 2: Implement health check functionality (AC: 2, 6)
  - [ ] Create health check endpoint in VIS integration service
  - [ ] Implement connectivity verification with timeout handling
  - [ ] Create monitoring dashboard widget for connection status display (see UI Design Specifications)
  - [ ] Add response time tracking and logging
  - [ ] Integrate health check into app status monitoring
- [ ] Task 3: Implement comprehensive error handling (AC: 3)
  - [ ] Create VIS-specific error types extending base error classes
  - [ ] Implement structured logging with correlation IDs
  - [ ] Add user-friendly error messages for VIS connectivity issues
  - [ ] Create error translation layer for VIS API responses
  - [ ] Implement error state management in BLoC pattern
- [ ] Task 4: Implement API rate limiting and retry logic (AC: 4)
  - [ ] Create rate limiting mechanism respecting 30-second intervals
  - [ ] Implement exponential backoff retry pattern (1s, 2s, 4s, 8s)
  - [ ] Add circuit breaker pattern for consecutive failures
  - [ ] Configure timeout settings (10s for VIS calls)
  - [ ] Implement request queuing for rate limit compliance
  - [ ] Create FIVB compliance validator for rate limit enforcement
  - [ ] Add compliance audit logging for all VIS API interactions
  - [ ] Implement rate limit headers monitoring and respect
- [ ] Task 7: Implement FIVB compliance features (Compliance requirement)
  - [ ] Create `FIVBComplianceValidator` class in `lib/core/compliance/`
  - [ ] Implement compliance monitoring dashboard widget
  - [ ] Add FIVB terms acceptance flow in application setup
  - [ ] Create data integrity validation against FIVB schemas
  - [ ] Implement usage reporting functionality for FIVB requests
  - [ ] Add proper FIVB attribution display components
- [ ] Task 5: Create unit tests for VIS integration (Testing requirement)
  - [ ] Create `test/unit/services/vis_integration_service_test.dart`
  - [ ] Mock VIS API responses using mockito
  - [ ] Test health check functionality with various scenarios
  - [ ] Test error handling and retry logic
  - [ ] Test rate limiting behavior
  - [ ] Achieve 90%+ test coverage for service layer
- [ ] Task 6: Create integration tests for VIS connectivity (Testing requirement)
  - [ ] Create `integration_test/vis_connectivity_test.dart`
  - [ ] Test end-to-end VIS API communication
  - [ ] Test health check endpoint functionality
  - [ ] Verify monitoring dashboard updates
  - [ ] Test error scenarios with mock VIS API failures
  - [ ] Test FIVB compliance validation scenarios
  - [ ] Test rate limiting enforcement and queuing behavior

## Dev Notes

### Previous Story Insights
From Story 1.1 completion:
- Flutter web project structure is established with proper lib/ organization
- Project follows Clean Architecture pattern with data/, domain/, presentation/, and services/ layers
- Environment configuration management is in place using .env files
- CI/CD pipeline is operational with GitHub Actions and Vercel deployment
- Testing framework is configured with 90%+ coverage requirement

### Data Models
[Source: architecture/data-models.md]
- **Tournament Entity**: Core entity with VIS identifier, name, location, dates, competition level, and status
- **CacheMetadata Entity**: Tracks data freshness and sync status for intelligent caching with sync timestamps and retry counters
- **Result<T, Error> Pattern**: All API responses must use consistent error handling pattern

### API Specifications
[Source: architecture/external-apis.md]
- **FIVB VIS API**: Official source for tournament, match, and referee data
- **Base URL**: TBD - requires FIVB coordination and configuration
- **Authentication**: API key or OAuth (requires negotiation with FIVB)
- **Rate Limits**: ~30 seconds between calls (negotiable for critical updates)
- **Key Endpoints**: `GET /tournaments` for tournament listings with filters
- **Integration Approach**: All VIS calls routed through Supabase Edge Functions for rate limiting, caching, and error handling

### Component Specifications
[Source: architecture/source-tree.md]
- **VIS Integration Service**: Located at `lib/services/vis_integration_service.dart`
- **Service Layer**: `lib/services/` directory contains all external service integrations
- **Error Classes**: Located in `lib/core/errors/` directory
- **Network Setup**: HTTP client configuration in `lib/core/network/` directory

### UI Design Specifications
[Source: design-requirements for dashboard health status widget]

**Dashboard Health Status Widget Requirements:**
- **Component Location**: `lib/presentation/widgets/health_status_widget.dart`
- **Widget Type**: StatefulWidget with real-time status updates
- **Layout Structure**:
  - Compact card design (max height: 120px, responsive width)
  - Header with "VIS Connection Status" title and refresh button
  - Main status indicator with color-coded visual feedback
  - Secondary metrics row showing response time and last check timestamp
  - Optional error message area (expandable on failure states)

**Visual Design Standards:**
- **Status Indicators**:
  - Connected: Green circle (Colors.green[600]) with "Connected" label
  - Connecting: Orange circle (Colors.orange[600]) with animated pulse and "Connecting..." label
  - Disconnected/Error: Red circle (Colors.red[600]) with "Disconnected" label
  - Unknown: Grey circle (Colors.grey[600]) with "Unknown" label
- **Typography**:
  - Title: Theme.textTheme.titleMedium (14px, semibold)
  - Status text: Theme.textTheme.bodyMedium (12px, medium)
  - Metrics: Theme.textTheme.bodySmall (10px, regular)
- **Spacing**: 8px internal padding, 4px between elements
- **Animations**: 1.2s pulse animation for connecting state, 300ms fade transitions

**Interaction Design:**
- Manual refresh button (IconButton with Icons.refresh)
- Tap-to-expand error details when in error state
- Tooltip on hover showing last successful connection timestamp
- Loading shimmer effect during initial load

**Responsive Behavior:**
- Mobile: Single column layout, condensed metrics
- Tablet/Desktop: Row layout with expanded metrics display
- Minimum width: 200px, maximum width: 400px

**Accessibility Requirements:**
- Semantic labels for screen readers
- High contrast mode support
- Keyboard navigation support for refresh action
- Status announcements for assistive technologies

### File Locations
[Source: architecture/source-tree.md]
Based on the established project structure:
- VIS Integration Service: `lib/services/vis_integration_service.dart`
- VIS Error Classes: `lib/core/errors/vis_error.dart`
- Network Configuration: `lib/core/network/http_client.dart`
- Health Status Widget: `lib/presentation/widgets/health_status_widget.dart`
- Dashboard Integration: `lib/presentation/pages/dashboard_page.dart`
- VIS Service Tests: `test/unit/services/vis_integration_service_test.dart`
- Widget Tests: `test/unit/widgets/health_status_widget_test.dart`
- Integration Tests: `integration_test/vis_connectivity_test.dart`

### Testing Requirements
[Source: architecture/test-strategy-and-standards.md]
- **Framework**: test 1.24.0+ with mockito 5.4.0+ for mocking
- **Coverage Requirement**: 90%+ for service and business logic classes
- **Test Organization**: `test/` mirrors `lib/` structure with `_test.dart` suffix
- **AI Agent Requirements**: Generate tests for all public methods, cover edge cases and error conditions, mock all external dependencies (VIS API)
- **Integration Tests**: Located in `integration_test/` directory, test service integration and external API workflows

### FIVB Compliance Requirements
[Source: FIVB VIS API Guidelines and Competition Regulations]

**Mandatory FIVB VIS Compliance Standards:**
- **API Authentication**: Must use FIVB-issued API credentials (API key or OAuth token)
- **Rate Limiting Compliance**: Strict adherence to 30-second minimum intervals between API calls
  - Implement request queuing to prevent accidental rate limit violations
  - Log all API calls with timestamps for FIVB audit requirements
  - Include rate limit headers monitoring and respect in all responses
- **Data Integrity**: All tournament and match data must maintain FIVB source integrity
  - No modification of official tournament results or referee assignments
  - Cache expiration must not exceed FIVB-specified freshness requirements (max 5 minutes for live data)
  - Implement data validation against FIVB schemas before local storage
- **Security Compliance**: 
  - API credentials must be stored securely (environment variables, never in code)
  - All VIS API communication must use HTTPS/TLS 1.3+
  - Implement request signing if required by FIVB authentication scheme
- **Error Handling Compliance**:
  - Must gracefully handle FIVB API maintenance windows (HTTP 503 responses)
  - Implement proper backoff during FIVB server overload conditions
  - Never retry more than 3 times for 4xx client errors
  - Log all API errors for FIVB support troubleshooting
- **Usage Reporting**: Track and report API usage statistics to FIVB if requested
- **Terms of Service**: Ensure all data usage complies with FIVB VIS Terms of Service
  - No redistribution of FIVB data without explicit permission
  - Proper attribution of FIVB as data source in all displays
  - Compliance with data retention policies

**Implementation Requirements:**
- Create `FIVBComplianceValidator` class to enforce compliance rules
- Implement compliance monitoring dashboard for rate limit tracking
- Add compliance audit logging for all VIS API interactions
- Include FIVB terms acceptance flow in application setup

### Technical Constraints
[Source: architecture/tech-stack.md, architecture/coding-standards.md, architecture/error-handling-strategy.md]
- **HTTP Client**: Use supabase_flutter 2.0.0+ for API communication
- **Rate Limiting**: Respect ~30 second intervals between VIS API calls using workmanager 0.5.0+
- **Error Handling**: Use Result<T, Error> pattern, never use print() in production, use logger service
- **Background Tasks**: All VIS calls through coordinated sync service, respect rate limits
- **Logging**: JSON structured logs with correlation IDs, strip PII and tokens from all log output
- **Retry Policy**: Exponential backoff (1s, 2s, 4s, 8s) for VIS API calls
- **Circuit Breaker**: Open circuit after 5 consecutive failures, close after 30s success
- **Timeout Configuration**: 10s for VIS calls
- **FIVB Compliance**: All API interactions must follow FIVB VIS compliance requirements (see above)

### Project Structure Notes
The project structure aligns with the established Clean Architecture pattern from Story 1.1:
- Services layer is properly organized in `lib/services/` directory
- Error handling follows the established pattern in `lib/core/errors/`
- Network configuration uses `lib/core/network/` for HTTP client setup
- Testing structure mirrors the lib/ organization as established
- No structural conflicts identified - VIS integration fits naturally into existing architecture

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-07-26 | 1.0 | Initial story creation for VIS API integration | Claude (Story Agent) |
| 2025-07-26 | 1.1 | Enhanced UI design guidance for dashboard widget and explicit FIVB compliance requirements | Claude (Story Enhancement) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be populated by dev agent*

### Debug Log References
*To be populated by dev agent*

### Completion Notes List
*To be populated by dev agent*

### File List
*To be populated by dev agent*

## QA Results
*Results from QA Agent review of the completed story implementation*