# Story 1.3: Add Referee Filtering Capability

## Status
Ready for Review

## Story
**As a** beach volleyball tournament viewer,  
**I want** to filter matches by specific referees,  
**so that** I can easily find matches officiated by referees I'm interested in watching or tracking.

## Acceptance Criteria
1. Extend the existing TournamentFilters component to include referee filtering options
2. Implement referee filter in the backend API to support filtering matches by referee name
3. Integrate referee filtering with the existing filter state management system

## Tasks / Subtasks
- [x] Task 1: Extend TournamentFilters interface and state management (AC: 1, 3)
  - [x] Add `referees?: string[]` field to TournamentFilters interface in `/frontend/src/types/tournament.types.ts`
  - [x] Update useFilters hook in `/frontend/src/hooks/useFilters.ts` to include `updateReferees` function
  - [x] Add referee filtering support to filter utilities in `/frontend/src/utils/filter.utils.ts`
  - [x] Update `buildFilterSummary` utility to include referee filter summary
  - [x] Add referee filter persistence to localStorage and URL query parameters
- [x] Task 2: Create RefereeFilter component (AC: 1)
  - [x] Create new component `/frontend/src/components/tournament/RefereeFilter.tsx` 
  - [x] Implement multi-select functionality with shadcn/ui Select component
  - [x] Add autocomplete/search capability for referee names
  - [x] Include loading states and error handling for referee data
  - [x] Support clearing individual referee selections
  - [x] Apply consistent styling with existing filter components
- [x] Task 3: Integrate RefereeFilter into TournamentFilters (AC: 1, 3)
  - [x] Add RefereeFilter to existing filter grid in `/frontend/src/components/tournament/TournamentFilters.tsx`
  - [x] Update grid layout from `grid-cols-1 md:grid-cols-4` to accommodate referee filter
  - [x] Connect RefereeFilter to useFilters hook `updateReferees` function
  - [x] Include referee filter in active filters summary display
  - [x] Support clearing referee filters through main clear filters action
- [x] Task 4: Implement backend referee filtering API (AC: 2)
  - [x] Add `/api/referees/search` endpoint in backend for referee autocomplete
  - [x] Extend existing tournament/match API endpoints to support referee filtering
  - [x] Update backend TournamentQueryParams to include referees filter parameter
  - [x] Implement referee filtering logic in tournament service layer
  - [x] Add proper error handling and validation for referee filter parameters
- [x] Task 5: Create comprehensive unit tests for referee filtering
  - [x] Test RefereeFilter component with complete referee data and search functionality
  - [x] Test TournamentFilters integration with referee filter active/inactive states
  - [x] Test useFilters hook referee filter state management and persistence
  - [x] Test backend API endpoint for referee search and filtering
  - [x] Test filter utilities with referee filter combinations
  - [x] Test responsive behavior and accessibility compliance

## Dev Notes

### Previous Story Insights
From Story 1.1 completion:
- Successfully extended Match interface with optional `referees` field containing `MatchReferees` type
- VIS API integration provides referee data with graceful error handling for missing data
- All referee fields are optional ensuring complete backward compatibility

From Story 1.2 completion:
- Enhanced MatchCard and MatchList components with referee display functionality
- Implemented responsive design with mobile single-line and desktop full display
- Added comprehensive accessibility support with ARIA labels and screen reader text

### Component Specifications
**RefereeFilter Component [Source: docs/referee-enhancement-frontend-specification.md#section-2.4]:**
- New component: `/frontend/src/components/tournament/RefereeFilter.tsx`
- Purpose: Dedicated referee filtering with autocomplete functionality
- Features: Multi-select with badges, loading states, clear all option, accessibility support

**TournamentFilters Integration [Source: docs/referee-enhancement-frontend-specification.md#section-2.2]:**
- Current component: `/frontend/src/components/tournament/TournamentFilters.tsx`
- Add referee filter to existing grid layout with grid expansion
- Integrate with existing useFilters hook pattern and buildFilterSummary utility
- Maintain consistent styling with existing filter components

### API Specifications
**New Backend Endpoints [Source: docs/referee-enhancement-frontend-specification.md#section-9.2]:**
- `/api/referees/search?q=` for autocomplete functionality
- Extended tournament/match APIs to support referee filtering parameter
- Request/response format for referee search with match count statistics

**Referee Search Response Structure:**
```typescript
interface RefereeSearchResponse {
  referees: Array<{
    name: string;
    country?: string;
    matchCount: number;
  }>;
}
```

### Data Model Integration
**TournamentFilters Extension [Source: docs/referee-enhancement-frontend-specification.md#section-3.2]:**
```typescript
export interface TournamentFilters {
  // ... existing fields
  referees?: string[]; // Array of referee names/IDs
}
```

**useFilters Hook Extension [Source: docs/referee-enhancement-frontend-specification.md#section-9.1]:**
```typescript
const updateReferees = useCallback((referees: string[]) => {
  updateFilters(prev => ({ ...prev, referees }));
}, [updateFilters]);
```

### File Locations
**Frontend Files to Create:**
- `/frontend/src/components/tournament/RefereeFilter.tsx` - New dedicated referee filter component

**Frontend Files to Modify:**
- `/frontend/src/types/tournament.types.ts` - Add referees field to TournamentFilters interface
- `/frontend/src/hooks/useFilters.ts` - Add updateReferees function and referee filter state management
- `/frontend/src/components/tournament/TournamentFilters.tsx` - Integrate RefereeFilter component
- `/frontend/src/utils/filter.utils.ts` - Add referee filter utility functions

**Backend Files to Modify:**  
- `/backend/src/types/tournament.types.ts` - Add referees field to TournamentQueryParams interface
- `/backend/src/routes/tournament.routes.ts` - Add referee search endpoint routes
- `/backend/src/controllers/tournament.controller.ts` - Add referee search and filtering controller methods
- `/backend/src/services/tournament.service.ts` - Implement referee filtering business logic

**Test Files to Create:**
- `/frontend/src/components/tournament/__tests__/RefereeFilter.test.tsx` - RefereeFilter component tests
- `/frontend/src/hooks/__tests__/useFilters.referee.test.ts` - useFilters referee functionality tests
- `/backend/src/controllers/__tests__/tournament.referee.test.ts` - Backend referee filtering API tests

### Technical Constraints
**Existing Filter Architecture [Source: current useFilters.ts and TournamentFilters.tsx analysis]:**
- Filter state managed through useFilters hook with localStorage and URL persistence
- Multi-select filters use string arrays (locations, types, statuses patterns)
- Filter grid uses responsive grid layout with shadcn/ui components
- buildFilterSummary utility generates active filter badges for display

**Integration Requirements:**
- Referee filter must integrate with existing filter clearing functionality
- Must maintain URL query parameter and localStorage persistence patterns
- Component styling must match existing DateRangeFilter, LocationFilter, TypeFilter components
- Backend filtering must work with existing tournament query infrastructure

**shadcn/ui Component Usage [Source: existing filter components analysis]:**
- Use Select component with multi-select capability for referee selection
- Apply Badge components for selected referee display
- Maintain consistent Button, Input, and Card styling patterns
- Follow existing responsive design patterns with Tailwind CSS classes

### Backend Integration Requirements
**API Endpoint Specifications:**
- GET `/api/referees/search?q={query}` - Autocomplete search for referee names
- Extend existing tournament/match endpoints with `referees` query parameter
- Return referee data with match count statistics for filtering relevance

**Database Integration:**
- Leverage existing referee data from Story 1.1 VIS API integration
- No additional database schema changes required - data sourced from VIS API
- Implement filtering logic in service layer using existing match data structures

### Testing Requirements
**Testing Standards [Source: existing package.json and test patterns from previous stories]:**
- Frontend: Jest + @testing-library/react for component tests
- Backend: Jest + Supertest for API integration tests
- Test location: `__tests__` directories alongside source files
- Coverage requirements: Test all referee filtering scenarios and state management

**Specific Testing Scenarios:**
- RefereeFilter component with available referees data and search functionality
- Multi-select referee filtering with badge display and removal
- Filter state persistence across browser sessions and URL navigation
- Backend API referee search with query parameters and response formatting
- Integration with existing filter clearing and summary functionality
- Error handling for referee search failures and empty result sets

## Testing

### Testing Standards
**Test File Locations:**
- `/frontend/src/components/tournament/__tests__/RefereeFilter.test.tsx` - RefereeFilter component tests
- `/frontend/src/hooks/__tests__/useFilters.referee.test.ts` - useFilters referee functionality tests
- `/backend/src/controllers/__tests__/tournament.referee.test.ts` - Backend referee API tests

**Testing Frameworks:**
- Jest for unit testing (both frontend and backend)
- @testing-library/react for frontend component testing
- Supertest for backend API testing
- @testing-library/jest-dom for DOM assertions

**Testing Patterns:**
- Follow existing test structure in tournament component and hook tests
- Use describe/it blocks for test organization
- Include multi-select behavior testing and filter state persistence
- Test API integration with mock data and error scenarios

**Coverage Requirements:**
- Test all referee filtering scenarios (single/multiple selection, search, clear)
- Test integration with existing filter system and state management
- Test backend API endpoint functionality and error handling
- Maintain existing coverage levels for modified components and services

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-28 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
No debug log entries required - implementation completed successfully on first attempt.

### Completion Notes List
- Successfully extended TournamentFilters interface with optional `referees` field for multi-select referee filtering
- Implemented comprehensive RefereeFilter component with autocomplete search functionality using debounced API calls
- Added robust error handling and loading states with graceful fallbacks for API failures
- Integrated RefereeFilter seamlessly into existing TournamentFilters component with responsive grid layout
- Updated useFilters hook with `updateReferees` function following established patterns for state management
- Enhanced filter utilities to support referee filtering in all helper functions (active detection, clearing, URL persistence)
- Implemented backend `/api/referees/search` endpoint with proper validation and error handling
- Added referee filtering support to tournament API with comma-separated parameter handling
- Created comprehensive test suites covering component behavior, hook functionality, and API integration
- Maintained backward compatibility and consistent styling patterns throughout implementation

### File List
**Frontend Files Created:**
- `/frontend/src/components/tournament/RefereeFilter.tsx` - New dedicated referee filter component with autocomplete
- `/frontend/src/components/tournament/__tests__/RefereeFilter.test.tsx` - Comprehensive component tests
- `/frontend/src/hooks/__tests__/useFilters.referee.test.ts` - Hook referee functionality tests

**Frontend Files Modified:**
- `/frontend/src/types/tournament.types.ts` - Added referees field to TournamentFilters and RefereeSearchResponse interface
- `/frontend/src/hooks/useFilters.ts` - Added updateReferees function and state management
- `/frontend/src/components/tournament/TournamentFilters.tsx` - Integrated RefereeFilter with responsive grid update
- `/frontend/src/utils/filter.utils.ts` - Added referee filter support to all utility functions

**Backend Files Created:**
- `/backend/src/routes/referee.routes.ts` - New referee API routes
- `/backend/src/controllers/__tests__/tournament.referee.test.ts` - Backend API tests for referee functionality

**Backend Files Modified:**
- `/backend/src/types/tournament.types.ts` - Added referees field to TournamentQueryParams and RefereeSearchResponse interface
- `/backend/src/controllers/tournament.controller.ts` - Added searchReferees method and referee parameter handling
- `/backend/src/services/tournament.service.ts` - Implemented referee search logic with VIS API integration
- `/backend/src/server.ts` - Registered referee routes and updated API documentation

## QA Results
*(To be populated by QA Agent)*